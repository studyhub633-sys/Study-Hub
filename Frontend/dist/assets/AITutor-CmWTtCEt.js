import{j as e,s as we,v as ne,w as je,M as ve,x as Ne,X as be,y as Ce,z as Se,A as ke,F as De,G as qe,H as Te,I as ie,J as Ee,L as oe,K as Ae}from"./ui-vendor-C99L-hD9.js";import{A as Ie,a as _e,b as Me,c as Le,d as ze,e as Pe,f as Fe,g as Re}from"./alert-dialog-Cw8WzYUx.js";import{B as v}from"./button-CQxizq7v.js";import{D as $e,a as He,b as Ke,c as le}from"./dropdown-menu-CDhNpXiy.js";import{I as ue}from"./input-BPzbhsiA.js";import{S as me}from"./scroll-area-LJgAfDZx.js";import{c as se,u as he,b as Oe}from"./index-bKh4zXg2.js";import{r as a,i as Qe,u as Be,j as We}from"./react-vendor-CW_qxVlV.js";import{A as Ge}from"./AppLayout-CLHhdqZB.js";import{S as Ue}from"./SimpleMarkdown-CgP23z8l.js";import{C as J,a as Y,b as V,c as ce,d as X}from"./card-B84tWNIN.js";import{T as Je}from"./textarea-D_YyEn4m.js";import{e as de,g as Ye,a as Ve,c as Xe}from"./ai-client-D_3hX6eY.js";import"./index-ORJz1BqE.js";import"./index-BOIwM99B.js";import"./index-BdQq_4o_.js";import"./supabase-vendor-BFJX04bJ.js";import"./query-vendor-CVP6rs-5.js";import"./sheet-CsgxYeIX.js";function Ze({sessions:s,currentSessionId:p,onSelectSession:H,onNewChat:u,onDeleteSession:g,onRenameSession:k,loading:A}){const[L,n]=a.useState(!1),[y,D]=a.useState(null),[q,T]=a.useState(""),[z,P]=a.useState(!1),[F,M]=a.useState(null),E=o=>{const l=new Date(o),w=new Date().getTime()-l.getTime(),x=Math.floor(w/(1e3*60)),f=Math.floor(w/(1e3*60*60)),j=Math.floor(w/(1e3*60*60*24));return x<1?"Just now":x<60?`${x}m ago`:f<24?`${f}h ago`:j===1?"Yesterday":j<7?`${j}d ago`:l.toLocaleDateString("en-US",{month:"short",day:"numeric"})},r=o=>{const l=new Date;l.setHours(0,0,0,0);const C=new Date(l);C.setDate(C.getDate()-1);const w=new Date(l);w.setDate(w.getDate()-7);const x=[{label:"Today",sessions:[]},{label:"Yesterday",sessions:[]},{label:"Previous 7 Days",sessions:[]},{label:"Older",sessions:[]}];return o.forEach(f=>{const j=new Date(f.updated_at);j.setHours(0,0,0,0),j.getTime()>=l.getTime()?x[0].sessions.push(f):j.getTime()>=C.getTime()?x[1].sessions.push(f):j.getTime()>=w.getTime()?x[2].sessions.push(f):x[3].sessions.push(f)}),x.filter(f=>f.sessions.length>0)},i=o=>{D(o.id),T(o.title)},c=async()=>{y&&q.trim()&&await k(y,q.trim()),D(null),T("")},h=()=>{D(null),T("")},N=o=>{M(o),P(!0)},b=async()=>{F&&await g(F),P(!1),M(null)},m=r(s);return L?e.jsxs("div",{className:"w-12 border-r border-border/50 bg-muted/30 flex flex-col items-center py-4 gap-2",children:[e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>n(!1),children:e.jsx(we,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:u,children:e.jsx(ne,{className:"h-4 w-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-64 border-r border-border/50 bg-muted/30 flex flex-col",children:[e.jsxs("div",{className:"p-3 border-b border-border/50 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:"Chat History"}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:()=>n(!0),children:e.jsx(je,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"p-3",children:e.jsxs(v,{variant:"outline",className:"w-full justify-start gap-2",onClick:u,children:[e.jsx(ne,{className:"h-4 w-4"}),"New Chat"]})}),e.jsx(me,{className:"flex-1",children:e.jsx("div",{className:"p-2 space-y-4",children:A?e.jsx("div",{className:"text-center text-muted-foreground text-sm py-8",children:"Loading..."}):s.length===0?e.jsxs("div",{className:"text-center text-muted-foreground text-sm py-8",children:[e.jsx(ve,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No chat history yet"}),e.jsx("p",{className:"text-xs mt-1",children:"Start a new conversation!"})]}):m.map(o=>e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground px-2 mb-2",children:o.label}),e.jsx("div",{className:"space-y-1",children:o.sessions.map(l=>e.jsxs("div",{className:se("group relative rounded-lg transition-colors",p===l.id?"bg-primary/10":"hover:bg-muted"),children:[y===l.id?e.jsxs("div",{className:"flex items-center gap-1 p-2",children:[e.jsx(ue,{value:q,onChange:C=>T(C.target.value),className:"h-7 text-sm",autoFocus:!0,onKeyDown:C=>{C.key==="Enter"&&c(),C.key==="Escape"&&h()}}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-7 w-7 shrink-0",onClick:c,children:e.jsx(Ne,{className:"h-3 w-3"})}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-7 w-7 shrink-0",onClick:h,children:e.jsx(be,{className:"h-3 w-3"})})]}):e.jsxs("button",{className:"w-full text-left p-2 pr-8",onClick:()=>H(l.id),children:[e.jsx("p",{className:"text-sm font-medium truncate text-foreground",children:l.title}),e.jsx("p",{className:"text-xs text-muted-foreground",children:E(l.updated_at)})]}),y!==l.id&&e.jsxs($e,{children:[e.jsx(He,{asChild:!0,children:e.jsx(v,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(Ce,{className:"h-4 w-4"})})}),e.jsxs(Ke,{align:"end",children:[e.jsxs(le,{onClick:()=>i(l),children:[e.jsx(Se,{className:"h-4 w-4 mr-2"}),"Rename"]}),e.jsxs(le,{className:"text-destructive focus:text-destructive",onClick:()=>N(l.id),children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]})]},l.id))})]},o.label))})})]}),e.jsx(Ie,{open:z,onOpenChange:P,children:e.jsxs(_e,{children:[e.jsxs(Me,{children:[e.jsx(Le,{children:"Delete Chat?"}),e.jsx(ze,{children:"This will permanently delete this chat and all its messages. This action cannot be undone."})]}),e.jsxs(Pe,{children:[e.jsx(Fe,{children:"Cancel"}),e.jsx(Re,{onClick:b,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete"})]})]})})]})}function es(){const{supabase:s,user:p}=he(),[H,u]=a.useState([]),[g,k]=a.useState(null),[A,L]=a.useState(!0),[n,y]=a.useState(null),D=a.useCallback(async()=>{if(!p||!s){u([]),L(!1);return}try{L(!0);const{data:r,error:i}=await s.from("ai_chat_sessions").select("*").eq("user_id",p.id).order("updated_at",{ascending:!1});if(i)throw i;u(r||[]),y(null)}catch(r){y(r.message)}finally{L(!1)}},[p,s]);a.useEffect(()=>{D()},[D]);const q=a.useCallback(async(r,i,c="chat")=>{if(!p||!s)return null;try{const h=r?[r]:[],N=r?r.content.slice(0,50)+(r.content.length>50?"...":""):"New Chat",{data:b,error:m}=await s.from("ai_chat_sessions").insert({user_id:p.id,title:N,messages:h,context:i||null,mode:c}).select().single();if(m)throw m;return u(o=>[b,...o]),k(b),b}catch(h){return y(h.message),null}},[p,s]),T=a.useCallback(async r=>{if(s)try{const{data:i,error:c}=await s.from("ai_chat_sessions").select("*").eq("id",r).single();if(c)throw c;k(i)}catch(i){y(i.message)}},[s]),z=a.useCallback(async(r,i)=>{if(s)try{const{data:c,error:h}=await s.from("ai_chat_sessions").update(i).eq("id",r).select().single();if(h)throw h;u(N=>N.map(b=>b.id===r?c:b)),(g==null?void 0:g.id)===r&&k(c)}catch(c){y(c.message)}},[s,g]),P=a.useCallback(async r=>{if(s)try{const{error:i}=await s.from("ai_chat_sessions").delete().eq("id",r);if(i)throw i;u(c=>c.filter(h=>h.id!==r)),(g==null?void 0:g.id)===r&&k(null)}catch(i){y(i.message)}},[s,g]),F=a.useCallback(async(r,i)=>{await z(r,{title:i})},[z]),M=a.useCallback(()=>{k(null)},[]),E=a.useCallback(async()=>{await D()},[D]);return{sessions:H,currentSession:g,loading:A,error:n,createSession:q,loadSession:T,updateSession:z,deleteSession:P,renameSession:F,clearCurrentSession:M,refreshSessions:E}}const Z=s=>({id:s.id,role:s.role,content:s.content,timestamp:s.timestamp.toISOString()}),ss=s=>({id:s.id,role:s.role,content:s.content,timestamp:new Date(s.timestamp)}),ee={id:"1",role:"assistant",content:`Hello! I'm your AI tutoring assistant. I can help you with:

â€¢ Explaining concepts from your notes
â€¢ Generating practice questions
â€¢ Evaluating your answers
â€¢ Providing study tips

What would you like to learn today?`,timestamp:new Date};function vs(){var ae;const{supabase:s,user:p}=he(),{toast:H}=Oe(),u=Qe(),g=Be(),[k,A]=We(),{sessions:L,currentSession:n,loading:y,createSession:D,loadSession:q,updateSession:T,deleteSession:z,renameSession:P,clearCurrentSession:F}=es(),[M,E]=a.useState([ee]),[r,i]=a.useState(""),[c,h]=a.useState(""),[N,b]=a.useState(!1),[m,o]=a.useState("chat"),[l,C]=a.useState(null),[w,x]=a.useState(null),f=a.useRef(null),j=a.useRef(!1),K=a.useRef(!1);a.useEffect(()=>{const t=k.get("session");t&&!n&&q(t)},[k,n,q]),a.useEffect(()=>{if(n){if(K.current){K.current=!1,A({session:n.id},{replace:!0});return}const t=n.messages.map(ss);E(t.length>0?t:[ee]),h(n.context||""),o(n.mode||"chat"),A({session:n.id},{replace:!0})}},[n,A]),a.useEffect(()=>{var t;(t=u.state)!=null&&t.context&&!n&&(h(u.state.context),u.state.mode&&o(u.state.mode),u.state.organizerTitle&&E([{id:"1",role:"assistant",content:`I have context from "${u.state.organizerTitle}". I can help you test your knowledge with practice questions based on this material. Would you like me to generate a question?`,timestamp:new Date}]))},[u.state,n]);const xe=async()=>{if(!(!p||!s))try{const t=new Date(Date.now()-864e5).toISOString(),{count:Q}=await s.from("ai_usage_tracking").select("*",{count:"exact",head:!0}).eq("user_id",p.id).gt("created_at",t),{data:d}=await s.from("profiles").select("is_premium, email").eq("id",p.id).single(),B=["admin@studyhub.com","tester@studyhub.com","andre@studyhub.com"],W=(d==null?void 0:d.is_premium)||B.includes((d==null?void 0:d.email)||"");C({count:Q||0,limit:W?500:10})}catch{}};a.useEffect(()=>{xe()},[p,s]),a.useEffect(()=>{f.current&&f.current.scrollIntoView({behavior:"smooth"})},[M]);const fe=a.useCallback(async t=>{n&&await T(n.id,{messages:t.map(Z)})},[n,T]),pe=a.useCallback(()=>{F(),E([ee]),h(""),o("chat"),x(null),j.current=!1,A({},{replace:!0})},[F,A]),ge=a.useCallback(t=>{q(t)},[q]),te=async()=>{var B,W,re;if(!r.trim()||N)return;const t={id:Date.now().toString(),role:"user",content:r,timestamp:new Date},Q=[...M,t];E(Q);const d=r;i(""),b(!0);try{let I="";if(w){const _=await de({correctAnswer:w.context,studentAnswer:d,threshold:.6},s);if(x(null),_.error)throw new Error(_.error);if(_.data){const{isCorrect:$,similarity:S,feedback:G}=_.data;I=`**Evaluation:**

${$?"âœ… Correct!":"âŒ Not quite right"}

**Similarity Score:** ${(S*100).toFixed(1)}%

**Feedback:** ${G||"Keep practicing!"}

---

Would you like another question? Just say "yes" or "next question"!`}else I="I couldn't evaluate your answer. Would you like to try another question?"}else{const _=m==="question"||d.toLowerCase().includes("generate question")||d.toLowerCase().includes("create question")||d.toLowerCase().includes("make a question")||d.toLowerCase().includes("ask me a question")||d.toLowerCase().includes("yes")||d.toLowerCase().includes("next question")||d.toLowerCase().includes("another question"),$=c.trim()||d;if(_&&$){const R=await(((B=u.state)==null?void 0:B.organizerTitle)?Ye:Ve)({context:$,subject:"General",difficulty:"medium"},s);if(R.error)throw new Error(R.error);(W=R.data)!=null&&W.question?(x({question:R.data.question,context:$}),I=`Here's a practice question based on your context:

**Question:**

${R.data.question}

---

Type your answer below, and I'll evaluate it!`):I="I couldn't generate a question. Please try again."}else if(m==="evaluate"&&c.trim()){const S=await de({correctAnswer:c,studentAnswer:d,threshold:.7},s);if(S.error)throw new Error(S.error);if(S.data){const{isCorrect:G,similarity:R,feedback:ye}=S.data;I=`**Evaluation:**

${G?"âœ… Correct!":"âŒ Not quite right"}

**Similarity Score:** ${(R*100).toFixed(1)}%

**Feedback:** ${ye||"Keep practicing!"}`}}else{const S=await Xe({message:d,context:$},s);if(S.error)throw new Error(S.error);I=((re=S.data)==null?void 0:re.reply)||"I couldn't generate a response. Please try again."}}const U={id:(Date.now()+1).toString(),role:"assistant",content:I,timestamp:new Date},O=[...Q,U];if(E(O),!n&&!j.current){j.current=!0,K.current=!0;const _=await D(Z(t),c||void 0,m);_&&(K.current=!0,await T(_.id,{messages:O.map(Z),title:d.slice(0,50)+(d.length>50?"...":"")}))}else n&&(K.current=!0,await fe(O))}catch(I){H({title:"Error",description:I.message||"Failed to get response. Please try again.",variant:"destructive"});const U={id:(Date.now()+1).toString(),role:"assistant",content:"I'm sorry, I encountered an error. Please try again or check your connection.",timestamp:new Date};E(O=>[...O,U])}finally{b(!1)}};return e.jsx(Ge,{children:e.jsxs("div",{className:"flex h-[calc(100vh-8rem)] gap-4",children:[e.jsx(Ze,{sessions:L,currentSessionId:(n==null?void 0:n.id)||null,onSelectSession:ge,onNewChat:pe,onDeleteSession:z,onRenameSession:P,loading:y}),e.jsxs("div",{className:"flex-1 flex flex-col min-w-0 space-y-4",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 animate-fade-in",children:e.jsxs("div",{children:[((ae=u.state)==null?void 0:ae.organizerTitle)&&e.jsxs(v,{variant:"ghost",className:"mb-2 p-0 h-auto hover:bg-transparent text-muted-foreground hover:text-foreground",onClick:()=>g("/knowledge"),children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Back to Knowledge Organizer"]}),e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(qe,{className:"h-6 w-6 text-primary"}),e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-foreground",children:"AI Tutoring Bot"})]}),e.jsx("p",{className:"text-muted-foreground",children:"Get personalized help with your studies"}),l&&e.jsxs("div",{className:"mt-2 inline-flex items-center px-3 py-1 rounded-full bg-primary/10 border border-primary/20 text-xs font-medium text-primary",children:[e.jsx(Te,{className:"h-3 w-3 mr-1"}),l.limit-l.count," AI generations remaining today"]})]})}),e.jsxs("div",{className:"flex gap-2 animate-slide-up",style:{animationDelay:"0.1s",opacity:0},children:[e.jsx(v,{variant:m==="chat"?"default":"outline",size:"sm",onClick:()=>{o("chat"),x(null)},children:"Chat"}),e.jsx(v,{variant:m==="question"?"default":"outline",size:"sm",onClick:()=>o("question"),children:"Generate Question"}),e.jsx(v,{variant:m==="evaluate"?"default":"outline",size:"sm",onClick:()=>{o("evaluate"),x(null)},children:"Evaluate Answer"})]}),w&&e.jsxs("div",{className:"bg-primary/10 border border-primary/30 rounded-lg p-3 text-sm",children:[e.jsx("span",{className:"font-medium text-primary",children:"ðŸ“ Waiting for your answer:"}),e.jsx("p",{className:"mt-1 text-foreground",children:w.question})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0",children:[e.jsx("div",{className:"lg:col-span-2 flex flex-col min-h-0",children:e.jsxs(J,{className:"flex-1 flex flex-col min-h-0",children:[e.jsxs(Y,{className:"shrink-0",children:[e.jsx(V,{children:"Conversation"}),e.jsxs(ce,{children:[m==="chat"&&"Ask me anything about your studies",m==="question"&&"I'll generate questions from your notes",m==="evaluate"&&"I'll evaluate your answers"]})]}),e.jsxs(X,{className:"flex-1 flex flex-col p-0 overflow-hidden min-h-0",children:[e.jsx(me,{className:"flex-1 px-6 min-h-0",children:e.jsxs("div",{className:"space-y-4 py-4",children:[M.map(t=>e.jsxs("div",{className:se("flex gap-3",t.role==="user"?"justify-end":"justify-start"),children:[t.role==="assistant"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0",children:e.jsx(ie,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:se("max-w-[80%] rounded-lg p-4",t.role==="user"?"bg-primary text-primary-foreground":"bg-muted text-foreground"),children:[t.role==="assistant"?e.jsx(Ue,{content:t.content,className:"text-sm"}):e.jsx("p",{className:"whitespace-pre-wrap text-sm break-words",children:t.content}),e.jsx("p",{className:"text-xs opacity-70 mt-2",children:t.timestamp.toLocaleTimeString()})]}),t.role==="user"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0",children:e.jsx(Ee,{className:"h-4 w-4 text-primary"})})]},t.id)),N&&e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(ie,{className:"h-4 w-4 text-primary"})}),e.jsx("div",{className:"bg-muted rounded-lg p-4",children:e.jsx(oe,{className:"h-4 w-4 animate-spin text-muted-foreground"})})]}),e.jsx("div",{ref:f})]})}),e.jsx("div",{className:"p-6 border-t border-border shrink-0",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ue,{value:r,onChange:t=>i(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),te())},placeholder:w||m==="evaluate"?"Type your answer here...":"Type your message...",disabled:N}),e.jsx(v,{onClick:te,disabled:N||!r.trim(),children:N?e.jsx(oe,{className:"h-4 w-4 animate-spin"}):e.jsx(Ae,{className:"h-4 w-4"})})]})})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(J,{children:[e.jsxs(Y,{children:[e.jsx(V,{children:"Context / Notes"}),e.jsx(ce,{children:"Paste your notes here for better assistance"})]}),e.jsxs(X,{children:[e.jsx(Je,{value:c,onChange:t=>h(t.target.value),placeholder:"Paste your notes, study material, or the correct answer here...",className:"min-h-[200px]"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:[m==="question"&&"I'll generate practice questions based on this context",m==="evaluate"&&"This should be the correct answer to compare against",m==="chat"&&"Provide context for better responses"]})]})]}),e.jsxs(J,{children:[e.jsx(Y,{children:e.jsx(V,{children:"Tips"})}),e.jsxs(X,{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsx("p",{children:"â€¢ Provide clear context from your notes for better questions"}),e.jsx("p",{children:'â€¢ Use "Generate Question" mode to create practice questions'}),e.jsx("p",{children:"â€¢ After a question is generated, just type your answer"}),e.jsx("p",{children:"â€¢ The AI will automatically evaluate your response"})]})]})]})]})]})]})})}export{vs as default};
