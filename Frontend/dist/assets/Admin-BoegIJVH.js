import{j as e,L as P,S as w,U as W,C as A,T as Y,o as R,p as Z,E as ee,q as se,r as ae}from"./ui-vendor-C99L-hD9.js";import{r as i,u as te}from"./react-vendor-CW_qxVlV.js";import{A as D}from"./AppLayout-CLHhdqZB.js";import{B as f}from"./button-CQxizq7v.js";import{I as re}from"./input-BPzbhsiA.js";import{c as m,u as ie,a as c}from"./index-bKh4zXg2.js";import{D as ne,a as le,b as ce,c as oe,d as de,e as me}from"./dialog-bV4jVpU1.js";import{i as xe}from"./premium-eVfGSoKP.js";import"./sheet-CsgxYeIX.js";import"./supabase-vendor-BFJX04bJ.js";import"./query-vendor-CVP6rs-5.js";const E=i.forwardRef(({className:t,...a},n)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:n,className:m("w-full caption-bottom text-sm",t),...a})}));E.displayName="Table";const z=i.forwardRef(({className:t,...a},n)=>e.jsx("thead",{ref:n,className:m("[&_tr]:border-b",t),...a}));z.displayName="TableHeader";const B=i.forwardRef(({className:t,...a},n)=>e.jsx("tbody",{ref:n,className:m("[&_tr:last-child]:border-0",t),...a}));B.displayName="TableBody";const he=i.forwardRef(({className:t,...a},n)=>e.jsx("tfoot",{ref:n,className:m("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",t),...a}));he.displayName="TableFooter";const U=i.forwardRef(({className:t,...a},n)=>e.jsx("tr",{ref:n,className:m("border-b transition-colors data-[state=selected]:bg-muted hover:bg-muted/50",t),...a}));U.displayName="TableRow";const h=i.forwardRef(({className:t,...a},n)=>e.jsx("th",{ref:n,className:m("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",t),...a}));h.displayName="TableHead";const u=i.forwardRef(({className:t,...a},n)=>e.jsx("td",{ref:n,className:m("p-4 align-middle [&:has([role=checkbox])]:pr-0",t),...a}));u.displayName="TableCell";const ue=i.forwardRef(({className:t,...a},n)=>e.jsx("caption",{ref:n,className:m("mt-4 text-sm text-muted-foreground",t),...a}));ue.displayName="TableCaption";const j="http://localhost:3001";function _e(){const{user:t,supabase:a}=ie(),n=te(),[L,F]=i.useState(!0),[y,H]=i.useState(!1),[M,J]=i.useState([]),[x,q]=i.useState(null),[S,G]=i.useState(""),[p,$]=i.useState(null),[o,C]=i.useState(null),[g,T]=i.useState(1),[v,O]=i.useState(1);i.useEffect(()=>{Q()},[t]);const Q=async()=>{if(!t||!a){n("/");return}const s=await xe(a,t.id);if(H(s),!s){c.error("Admin access required"),n("/");return}X()},X=async()=>{if(!(!t||!a)){F(!0);try{await Promise.all([N(),_()])}catch{c.error("Failed to load admin data")}finally{F(!1)}}},N=async()=>{var s;if(!(!t||!a))try{const{data:{session:r}}=await a.auth.getSession();if(!r)return;const l=await fetch(`${j}/api/admin/users?page=${g}&limit=20&search=${S}`,{headers:{Authorization:`Bearer ${r.access_token}`}}),d=await l.json();l.ok?(J(d.users||[]),O(((s=d.pagination)==null?void 0:s.totalPages)||1)):c.error(d.error||"Failed to load users")}catch{c.error("Failed to load users")}},_=async()=>{if(!(!t||!a))try{const{data:{session:s}}=await a.auth.getSession();if(!s)return;const r=await fetch(`${j}/api/admin/stats`,{headers:{Authorization:`Bearer ${s.access_token}`}}),l=await r.json();r.ok&&q(l)}catch{}},k=async s=>{if(!(!t||!a))try{const{data:{session:r}}=await a.auth.getSession();if(!r)return;const l=await fetch(`${j}/api/admin/users/${s}`,{headers:{Authorization:`Bearer ${r.access_token}`}}),d=await l.json();l.ok?C(d):c.error(d.error||"Failed to load user details")}catch{c.error("Failed to load user details")}},I=async(s,r)=>{if(!(!t||!a))try{const{data:{session:l}}=await a.auth.getSession();if(!l)return;const d=await fetch(`${j}/api/admin/users/${s}/premium`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.access_token}`},body:JSON.stringify({is_premium:r})}),b=await d.json();d.ok?(c.success(b.message||`Premium access ${r?"granted":"revoked"}`),N(),_(),(p==null?void 0:p.id)===s&&k(s)):c.error(b.error||"Failed to update premium status")}catch{c.error("Failed to update premium status")}},K=async(s,r)=>{if(!(!t||!a))try{const{data:{session:l}}=await a.auth.getSession();if(!l)return;const d=await fetch(`${j}/api/admin/users/${s}/admin`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.access_token}`},body:JSON.stringify({is_admin:r})}),b=await d.json();d.ok?(c.success(b.message||`Admin access ${r?"granted":"revoked"}`),N(),(p==null?void 0:p.id)===s&&k(s)):c.error(b.error||"Failed to update admin status")}catch{c.error("Failed to update admin status")}},V=async s=>{if(confirm("Are you sure you want to delete this user? This action cannot be undone.")&&!(!t||!a))try{const{data:{session:r}}=await a.auth.getSession();if(!r)return;const l=await fetch(`${j}/api/admin/users/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${r.access_token}`}}),d=await l.json();l.ok?(c.success("User deleted successfully"),N(),_(),$(null),C(null)):c.error(d.error||"Failed to delete user")}catch{c.error("Failed to delete user")}};return i.useEffect(()=>{y&&N()},[g,S,y]),y?L&&!x?e.jsx(D,{children:e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(P,{className:"h-8 w-8 animate-spin text-primary"})})}):e.jsx(D,{children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-foreground flex items-center gap-2",children:[e.jsx(w,{className:"h-8 w-8 text-premium"}),"Admin Dashboard"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage users, subscriptions, and payments"})]})}),x&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"glass-card p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(W,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Users"})]}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:x.totalUsers})]}),e.jsxs("div",{className:"glass-card p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(A,{className:"h-5 w-5 text-premium"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Premium Users"})]}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:x.premiumUsers})]}),e.jsxs("div",{className:"glass-card p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Y,{className:"h-5 w-5 text-secondary"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Active Subs"})]}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:x.activeSubscriptions})]}),e.jsxs("div",{className:"glass-card p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(R,{className:"h-5 w-5 text-accent"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Revenue"})]}),e.jsxs("p",{className:"text-2xl font-bold text-foreground",children:["£",x.totalRevenue.toFixed(2)]})]}),e.jsxs("div",{className:"glass-card p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(R,{className:"h-5 w-5 text-secondary"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Monthly Revenue"})]}),e.jsxs("p",{className:"text-2xl font-bold text-foreground",children:["£",x.monthlyRevenue.toFixed(2)]})]})]}),e.jsxs("div",{className:"glass-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Users"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(re,{placeholder:"Search users...",value:S,onChange:s=>{G(s.target.value),T(1)},className:"pl-9 w-64"})]})})]}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(E,{children:[e.jsx(z,{children:e.jsxs(U,{children:[e.jsx(h,{children:"Email"}),e.jsx(h,{children:"Name"}),e.jsx(h,{children:"Premium"}),e.jsx(h,{children:"Admin"}),e.jsx(h,{children:"Joined"}),e.jsx(h,{className:"text-right",children:"Actions"})]})}),e.jsx(B,{children:M.map(s=>e.jsxs(U,{children:[e.jsx(u,{className:"font-medium",children:s.email}),e.jsx(u,{children:s.full_name||"—"}),e.jsx(u,{children:s.is_premium?e.jsxs("span",{className:"inline-flex items-center gap-1 text-premium",children:[e.jsx(A,{className:"h-4 w-4"}),"Premium"]}):e.jsx("span",{className:"text-muted-foreground",children:"Free"})}),e.jsx(u,{children:s.is_admin?e.jsxs("span",{className:"inline-flex items-center gap-1 text-premium",children:[e.jsx(w,{className:"h-4 w-4"}),"Admin"]}):e.jsx("span",{className:"text-muted-foreground",children:"—"})}),e.jsx(u,{className:"text-sm text-muted-foreground",children:new Date(s.created_at).toLocaleDateString()}),e.jsx(u,{className:"text-right",children:e.jsx("div",{className:"flex items-center justify-end gap-2",children:e.jsxs(ne,{children:[e.jsx(le,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>{$(s),k(s.id)},children:e.jsx(ee,{className:"h-4 w-4"})})}),e.jsxs(ce,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(oe,{children:[e.jsx(de,{children:"User Details"}),e.jsx(me,{children:"Manage user account and permissions"})]}),o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Profile"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Email:"})," ",o.profile.email]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"})," ",o.profile.full_name||"—"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Joined:"})," ",new Date(o.profile.created_at).toLocaleString()]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Permissions"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:"Premium:"}),e.jsx(f,{variant:o.profile.is_premium?"default":"outline",size:"sm",onClick:()=>I(s.id,!o.profile.is_premium),children:o.profile.is_premium?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"h-4 w-4 mr-1"}),"Revoke"]}):e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"h-4 w-4 mr-1"}),"Grant"]})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:"Admin:"}),e.jsx(f,{variant:o.profile.is_admin?"default":"outline",size:"sm",onClick:()=>K(s.id,!o.profile.is_admin),children:o.profile.is_admin?e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"h-4 w-4 mr-1"}),"Revoke"]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"h-4 w-4 mr-1"}),"Grant"]})})]})]})]}),o.subscription&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Subscription"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Plan:"})," ",o.subscription.plan_type]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"})," ",o.subscription.status]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Period End:"})," ",new Date(o.subscription.current_period_end).toLocaleDateString()]})]})]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(f,{variant:"destructive",size:"sm",onClick:()=>V(s.id),children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Delete User"]})})]})]})]})})})]},s.id))})]})}),v>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Page ",g," of ",v]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{variant:"outline",size:"sm",onClick:()=>T(s=>Math.max(1,s-1)),disabled:g===1,children:"Previous"}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>T(s=>Math.min(v,s+1)),disabled:g===v,children:"Next"})]})]})]})]})}):e.jsx(D,{children:e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(P,{className:"h-8 w-8 animate-spin text-primary"})})})}export{_e as default};
