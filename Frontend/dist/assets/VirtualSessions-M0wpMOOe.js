import{j as e,b2 as R,N as A,L as B,aa as xe,U as pe,aw as ge,aj as J,Z as fe,$ as je,ay as _e}from"./ui-vendor-DvDVRjyp.js";import{h as ve,A as ye}from"./AppLayout-DSG6wxEf.js";import{B as _}from"./badge-BcqXIc_g.js";import{u as be,k as Ne,B as p,C as we}from"./index-DEqmCALs.js";import{C as Se,d as ke}from"./card-C99jCs8O.js";import{D as Y,b as W,c as K,d as Z,e as Q,f as X}from"./dialog-CeMj4lUC.js";import{I as w}from"./input-CG8Ib3hH.js";import{L as v}from"./label-lvNOnDGI.js";import{S as Ce,a as De,b as Ee,c as Ie,d as y}from"./select-9ZKIQjAc.js";import{T as Te}from"./textarea-F7PLQ3VZ.js";import{r as c}from"./react-vendor-Do86TxWo.js";import"./AnimatedLogoIcon-D6d7HWVb.js";import"./sheet-DlQTD0RE.js";import"./supabase-vendor-C2nLxrxH.js";import"./query-vendor-Bk-KKE7Z.js";import"./index-BdQq_4o_.js";import"./index-Du_rhl89.js";function Ke(){const{supabase:g,user:a}=be(),{toast:m}=Ne(),[ee,F]=c.useState(!0),[C,D]=c.useState([]),[E,b]=c.useState(!1),[I,te]=c.useState(!1),[T,se]=c.useState([]),[U,z]=c.useState([]),[Ue,$]=c.useState(!1),[M,G]=c.useState(!1),[ie,P]=c.useState(!1),[N,V]=c.useState(!1),[u,L]=c.useState(null),[i,f]=c.useState({title:"",description:"",subject:"",tutor_name:"",scheduled_time:"",duration_minutes:"60",max_attendees:"50"});c.useEffect(()=>{a&&(S(),re())},[a]),c.useEffect(()=>{E&&a&&ae()},[E,a]);const ae=async()=>{if(a){$(!0);try{const t=[],{data:s}=await g.from("past_papers").select("id, title, subject").eq("user_id",a.id).order("created_at",{ascending:!1}).limit(50);s&&s.forEach(o=>{t.push({id:o.id,title:o.title,subject:o.subject||void 0,type:"past_paper"})});const{data:l}=await g.from("knowledge_organizers").select("id, title, subject").eq("user_id",a.id).order("created_at",{ascending:!1}).limit(50);l&&l.forEach(o=>{t.push({id:o.id,title:o.title,subject:o.subject||void 0,type:"knowledge_organizer"})});const{data:r}=await g.from("flashcards").select("id, front, subject, topic").eq("user_id",a.id).order("created_at",{ascending:!1}).limit(100);if(r){const o=new Map;r.forEach(h=>{const x=h.topic||h.subject||"General";o.has(x)||o.set(x,{count:0,subject:h.subject||void 0,topic:h.topic||void 0}),o.get(x).count++}),o.forEach((h,x)=>{t.push({id:`flashcard-group-${x}`,title:`${x} (${h.count} cards)`,subject:h.subject,type:"flashcard"})})}se(t)}catch{}finally{$(!1)}}},re=async()=>{if(a&&g){const t=await ve(g);te(t)}},S=async()=>{try{F(!0);const t=g.from("virtual_sessions").select("*").in("status",["upcoming","live"]).order("scheduled_time",{ascending:!0}),{data:s,error:l}=await t;if(l){D([]);return}s&&D(s)}catch{D([])}finally{F(!1)}},ne=()=>{const t=Date.now(),s=Math.random().toString(36).substring(2,8);return`study-hub-${t}-${s}`},le=async()=>{var t;if(!a){m({title:"Error",description:"Please sign in to create a session.",variant:"destructive"});return}if(!i.title.trim()||!i.tutor_name.trim()||!i.scheduled_time&&!N&&!u){m({title:"Error",description:"Please fill in all required fields.",variant:"destructive"});return}G(!0);try{const s=u?u.meeting_room_id:ne(),l=`https://meet.jit.si/${s}`;let r=i.scheduled_time;N&&(r=new Date().toISOString());const o=U.filter(n=>{var d;return((d=T.find(j=>j.id===n))==null?void 0:d.type)==="past_paper"}),h=U.filter(n=>{var d;return((d=T.find(j=>j.id===n))==null?void 0:d.type)==="knowledge_organizer"}),x=U.filter(n=>{var d;return((d=T.find(j=>j.id===n))==null?void 0:d.type)==="flashcard"}),k=u?u.verification_token:crypto.randomUUID();if(u){const{error:n}=await g.from("virtual_sessions").update({title:i.title,description:i.description||null,subject:i.subject||null,tutor_name:i.tutor_name,scheduled_time:r,duration_minutes:parseInt(i.duration_minutes)||60,max_attendees:parseInt(i.max_attendees)||50}).eq("id",u.id).select();if(n)throw n;m({title:"Session Updated!",description:"Your session details have been updated."})}else{const{error:n}=await g.from("virtual_sessions").insert({created_by:a.id,title:i.title,description:i.description||null,subject:i.subject||null,tutor_name:i.tutor_name,scheduled_time:r,duration_minutes:parseInt(i.duration_minutes)||60,max_attendees:parseInt(i.max_attendees)||50,meeting_room_id:s,meeting_url:l,linked_past_papers:null,linked_knowledge_organizers:null,linked_flashcards:null,email_verified:!0,verification_token:k,status:"upcoming"});if(n)throw n;m({title:"Session Created!",description:"Your session is now live and visible to everyone."})}if(N){const n=((t=a.email)==null?void 0:t.split("@")[0])||"Host",d=`${l}#userInfo.displayName="${encodeURIComponent(n)}"&config.prejoinPageEnabled=false`;window.open(d,"_blank","width=1200,height=800"),P(!0)}b(!1),L(null),f({title:"",description:"",subject:"",tutor_name:"",scheduled_time:"",duration_minutes:"60",max_attendees:"50"}),z([]),S()}catch(s){m({title:"Error",description:s.message||"Failed to save session. Please try again.",variant:"destructive"})}finally{G(!1)}},oe=async t=>{if(confirm("Are you sure you want to delete this session? This action cannot be undone."))try{const{error:s}=await g.from("virtual_sessions").delete().eq("id",t);if(s)throw s;m({title:"Session Deleted",description:"The session has been successfully removed."}),S()}catch{m({title:"Error",description:"Failed to delete session.",variant:"destructive"})}},de=t=>{L(t),f({title:t.title,description:t.description||"",subject:t.subject||"",tutor_name:t.tutor_name,scheduled_time:t.scheduled_time,duration_minutes:t.duration_minutes.toString(),max_attendees:t.max_attendees.toString()}),V(!1),b(!0)},ce=async t=>{if(!a){m({title:"Error",description:"Please sign in to register for sessions.",variant:"destructive"});return}try{const s=C.find(r=>r.id===t);if(!s)return;if(s.registered_users.includes(a.id)){m({title:"Already Registered",description:"You are already registered for this session."});return}const{error:l}=await g.rpc("register_for_session",{session_id_param:t,user_id_param:a.id});if(l)throw l;m({title:"Success",description:"You have been registered for this session!"}),S()}catch{m({title:"Error",description:"Failed to register. Please try again.",variant:"destructive"})}},me=t=>{var r;const s=((r=a==null?void 0:a.email)==null?void 0:r.split("@")[0])||"Guest",l=`${t.meeting_url}#userInfo.displayName="${encodeURIComponent(s)}"&config.prejoinPageEnabled=false`;window.open(l,"_blank","width=1200,height=800"),a&&t.created_by===a.id&&m({title:"Starting Session",description:"Remember to log in as default moderator if prompted."})},ue=t=>{const s=new Date(t),l=new Date,r=(s.getTime()-l.getTime())/(1e3*60*60);return r<0?"Past":r<24?`Today, ${s.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`:r<48?`Tomorrow, ${s.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`:s.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})},he=t=>{const s=new Date(t);return{month:s.toLocaleDateString("en-US",{month:"short"}).toUpperCase(),day:s.getDate().toString()}};return e.jsxs(ye,{children:[e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6 animate-fade-in pb-12",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-3 rounded-xl bg-indigo-500/10 text-indigo-500",children:e.jsx(R,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Virtual Group Sessions"}),e.jsx("p",{className:"text-muted-foreground",children:"Live revision sessions led by expert tutors every week."})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Upcoming Sessions"}),I&&e.jsxs(p,{onClick:()=>{L(null),f({title:"",description:"",subject:"",tutor_name:"",scheduled_time:"",duration_minutes:"60",max_attendees:"50"}),b(!0)},children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"Create Session"]})]}),ee?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(B,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"space-y-4",children:C.length===0?e.jsxs("div",{className:"text-center py-12 border rounded-xl border-dashed",children:[e.jsx(R,{className:"w-12 h-12 mx-auto text-muted-foreground mb-3 opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold text-muted-foreground",children:"No Upcomming Sessions"}),e.jsxs("p",{className:"text-sm text-muted-foreground max-w-sm mx-auto mt-1",children:["There are no verified sessions scheduled at the moment. ",I?"Create one to get started!":"Check back later!"]}),I&&e.jsxs(p,{variant:"outline",className:"mt-4",onClick:()=>b(!0),children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"Create Session"]})]}):C.map(t=>{var H,O,q;const s=he(t.scheduled_time),l=a&&t.registered_users.includes(a.id),r=new Date(t.scheduled_time),o=(t.duration_minutes||60)*60*1e3,h=new Date(r.getTime()+o),x=new Date,k=x>=r&&x<=h,n=x>h,d=a&&t.created_by===a.id,j=(k||t.status==="live"||d)&&!n;return e.jsx(Se,{className:"group hover:border-indigo-500/50 transition-colors",children:e.jsxs(ke,{className:"p-6 flex flex-col md:flex-row md:items-center gap-6",children:[e.jsxs("div",{className:"flex-shrink-0 w-16 h-16 rounded-xl bg-indigo-100 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 flex flex-col items-center justify-center font-bold",children:[e.jsx("span",{className:"text-xs uppercase opacity-70",children:s.month}),e.jsx("span",{className:"text-2xl",children:s.day})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.subject&&e.jsx(_,{variant:"outline",className:"text-xs",children:t.subject}),k?e.jsx(_,{variant:"default",className:"text-xs animate-pulse bg-red-500 hover:bg-red-600",children:"LIVE NOW"}):n?e.jsx(_,{variant:"secondary",className:"text-xs",children:"Completed"}):e.jsx(_,{variant:"secondary",className:"text-xs",children:"Upcoming"}),e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center",children:[e.jsx(xe,{className:"w-3 h-3 mr-1"}),ue(t.scheduled_time),e.jsxs("span",{className:"ml-1",children:["(",t.duration_minutes," mins)"]})]})]}),e.jsx("h3",{className:"text-xl font-bold group-hover:text-indigo-500 transition-colors",children:t.title}),t.description&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:t.description}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Hosted by ",t.tutor_name," â€¢ ",e.jsx(pe,{className:"w-3 h-3 inline pb-0.5"})," ",t.registered_users.length," registered"]}),(((H=t.linked_past_papers)==null?void 0:H.length)||((O=t.linked_knowledge_organizers)==null?void 0:O.length)||((q=t.linked_flashcards)==null?void 0:q.length))&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[t.linked_past_papers&&t.linked_past_papers.length>0&&e.jsxs(_,{variant:"outline",className:"text-xs",children:[e.jsx(ge,{className:"w-3 h-3 mr-1"}),t.linked_past_papers.length," Past Paper",t.linked_past_papers.length>1?"s":""]}),t.linked_knowledge_organizers&&t.linked_knowledge_organizers.length>0&&e.jsxs(_,{variant:"outline",className:"text-xs",children:[e.jsx(J,{className:"w-3 h-3 mr-1"}),t.linked_knowledge_organizers.length," Knowledge Organizer",t.linked_knowledge_organizers.length>1?"s":""]}),t.linked_flashcards&&t.linked_flashcards.length>0&&e.jsxs(_,{variant:"outline",className:"text-xs",children:[e.jsx(J,{className:"w-3 h-3 mr-1"}),t.linked_flashcards.length," Flashcard Set",t.linked_flashcards.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[d&&e.jsxs(e.Fragment,{children:[e.jsx(p,{variant:"outline",size:"icon",onClick:()=>de(t),title:"Edit Session",children:e.jsx(fe,{className:"w-4 h-4"})}),e.jsx(p,{variant:"outline",size:"icon",className:"text-red-500 hover:text-red-600 hover:bg-red-50",onClick:()=>oe(t.id),title:"Delete Session",children:e.jsx(je,{className:"w-4 h-4"})})]}),j?e.jsxs(p,{className:d?"bg-amber-600 hover:bg-amber-700":"bg-green-600 hover:bg-green-700",onClick:()=>me(t),children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),d?"Start Session":"Join Session"]}):l?e.jsx(p,{variant:"outline",disabled:!0,children:"Registered"}):n?e.jsx(p,{variant:"ghost",disabled:!0,children:"Ended"}):e.jsx(p,{className:"bg-indigo-600 hover:bg-indigo-700",onClick:()=>ce(t.id),children:"Register Now"})]})]})},t.id)})})})]}),e.jsx(Y,{open:E,onOpenChange:b,children:e.jsxs(W,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(K,{children:[e.jsx(Z,{children:u?"Edit Virtual Session":"Create Virtual Session"}),e.jsx(Q,{children:u?"Update your session details.":"Create a new virtual group revision session using Jitsi Meet."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"title",children:"Session Title *"}),e.jsx(w,{id:"title",value:i.title,onChange:t=>f({...i,title:t.target.value}),placeholder:"e.g., GCSE Maths: Algebra Revision"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"description",children:"Description"}),e.jsx(Te,{id:"description",value:i.description,onChange:t=>f({...i,description:t.target.value}),placeholder:"What will be covered in this session?",className:"min-h-[100px]"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"subject",children:"Subject"}),e.jsxs(Ce,{value:i.subject,onValueChange:t=>f({...i,subject:t}),children:[e.jsx(De,{children:e.jsx(Ee,{placeholder:"Select subject"})}),e.jsxs(Ie,{children:[e.jsx(y,{value:"Mathematics",children:"Mathematics"}),e.jsx(y,{value:"English Literature",children:"English Literature"}),e.jsx(y,{value:"Biology",children:"Biology"}),e.jsx(y,{value:"Chemistry",children:"Chemistry"}),e.jsx(y,{value:"Physics",children:"Physics"}),e.jsx(y,{value:"History",children:"History"}),e.jsx(y,{value:"Geography",children:"Geography"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"tutor_name",children:"Tutor Name *"}),e.jsx(w,{id:"tutor_name",value:i.tutor_name,onChange:t=>f({...i,tutor_name:t.target.value}),placeholder:"e.g., Dr. Smith"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(v,{htmlFor:"scheduled_time",children:"Scheduled Time *"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(we,{id:"start-now",checked:N,onCheckedChange:t=>V(t===!0)}),e.jsx("label",{htmlFor:"start-now",className:"text-xs font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer text-indigo-600",children:"Start Now"})]})]}),e.jsx(w,{id:"scheduled_time",type:"datetime-local",value:i.scheduled_time,onChange:t=>f({...i,scheduled_time:t.target.value}),disabled:N})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"duration_minutes",children:"Duration (minutes)"}),e.jsx(w,{id:"duration_minutes",type:"number",value:i.duration_minutes,onChange:t=>f({...i,duration_minutes:t.target.value}),placeholder:"60"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"max_attendees",children:"Max Attendees"}),e.jsx(w,{id:"max_attendees",type:"number",value:i.max_attendees,onChange:t=>f({...i,max_attendees:t.target.value}),placeholder:"50"})]})]}),e.jsxs(X,{children:[e.jsx(p,{variant:"outline",onClick:()=>{b(!1),z([])},children:"Cancel"}),e.jsx(p,{onClick:le,disabled:M,children:M?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"w-4 h-4 mr-2 animate-spin"}),u?"Update Session":"Create Session"]}):u?"Update Session":"Create Session"})]})]})}),e.jsx(Y,{open:ie,onOpenChange:P,children:e.jsxs(W,{children:[e.jsxs(K,{children:[e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-full bg-amber-100 text-amber-600",children:e.jsx(_e,{className:"w-5 h-5"})}),"Important: Start Your Meeting"]}),e.jsx(Q,{children:"Jitsi Meet requires the Creator (You) to officially start the meeting."})]}),e.jsx("div",{className:"space-y-4 py-2",children:e.jsxs("div",{className:"p-4 bg-muted rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold text-xs",children:"1"}),e.jsxs("p",{className:"text-sm",children:["In the Jitsi window that just opened, look for the ",e.jsx("strong",{children:'"Log In"'}),' or "I am the host" button.']})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold text-xs",children:"2"}),e.jsx("p",{className:"text-sm",children:"Log in with your Google or GitHub account to claim the room."})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold text-xs",children:"3"}),e.jsx("p",{className:"text-sm",children:"Once you are in, other participants will automatically join."})]})]})}),e.jsx(X,{children:e.jsx(p,{onClick:()=>P(!1),children:"I Understand"})})]})})]})}export{Ke as default};
