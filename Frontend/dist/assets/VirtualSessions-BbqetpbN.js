import{c as me,u as ue,n as he,r as o,j as e,B as p,L as G,s as xe}from"./index-7wMNJNZJ.js";import{h as pe,A as ge}from"./AppLayout-Cb4f3Rcb.js";import{B as j}from"./badge-CT5QE6KZ.js";import{C as fe,d as je}from"./card-BDQx_yt9.js";import{D as H,b as O,c as q,d as A,e as B,f as J}from"./dialog-CGZvDN6x.js";import{I as N}from"./input-CURGwIC-.js";import{L as _}from"./label-4_8C0ZIE.js";import{S as _e,a as ve,b as ye,c as be,d as v}from"./select-Do0TjdJZ.js";import{T as Ne}from"./textarea-DYv1Zddw.js";import{P as Y}from"./plus-BgtP8iNg.js";import{C as we}from"./clock-BKqJKRJR.js";import{U as Se}from"./users-BPQvDXIc.js";import{F as ke,L as W}from"./sheet-D4eoD1m7.js";import{P as Ce}from"./pencil-BPthp9JK.js";import{T as De}from"./trash-2-CodGuS8N.js";import{T as Ie}from"./triangle-alert-llFSr_Vx.js";import"./AnimatedLogoIcon-DY32PEux.js";import"./sun-CnDoiXzg.js";import"./index-BdQq_4o_.js";import"./index-8ugP4A3I.js";import"./chevron-down-CjDqse4M.js";const U=me("Video",[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]]);function Xe(){const{supabase:g,user:a}=ue(),{toast:d}=he(),[K,R]=o.useState(!0),[k,C]=o.useState([]),[D,y]=o.useState(!1),[I,Q]=o.useState(!1),[E,X]=o.useState([]),[T,F]=o.useState([]),[Ee,z]=o.useState(!1),[V,$]=o.useState(!1),[Z,L]=o.useState(!1),[b,M]=o.useState(!1),[u,P]=o.useState(null),[i,f]=o.useState({title:"",description:"",subject:"",tutor_name:"",scheduled_time:"",duration_minutes:"60",max_attendees:"50"});o.useEffect(()=>{a&&(w(),te())},[a]),o.useEffect(()=>{D&&a&&ee()},[D,a]);const ee=async()=>{if(a){z(!0);try{const t=[],{data:s}=await g.from("past_papers").select("id, title, subject").eq("user_id",a.id).order("created_at",{ascending:!1}).limit(50);s&&s.forEach(l=>{t.push({id:l.id,title:l.title,subject:l.subject||void 0,type:"past_paper"})});const{data:r}=await g.from("knowledge_organizers").select("id, title, subject").eq("user_id",a.id).order("created_at",{ascending:!1}).limit(50);r&&r.forEach(l=>{t.push({id:l.id,title:l.title,subject:l.subject||void 0,type:"knowledge_organizer"})});const{data:c}=await g.from("flashcards").select("id, front, subject, topic").eq("user_id",a.id).order("created_at",{ascending:!1}).limit(100);if(c){const l=new Map;c.forEach(h=>{const m=h.topic||h.subject||"General";l.has(m)||l.set(m,{count:0,subject:h.subject||void 0,topic:h.topic||void 0}),l.get(m).count++}),l.forEach((h,m)=>{t.push({id:`flashcard-group-${m}`,title:`${m} (${h.count} cards)`,subject:h.subject,type:"flashcard"})})}X(t)}catch{}finally{z(!1)}}},te=async()=>{if(a&&g){const t=await pe(g);Q(t)}},w=async()=>{try{R(!0);const t=g.from("virtual_sessions").select("*").in("status",["upcoming","live"]).order("scheduled_time",{ascending:!0}),{data:s,error:r}=await t;if(r){C([]);return}s&&C(s)}catch{C([])}finally{R(!1)}},se=()=>{const t=Date.now(),s=Math.random().toString(36).substring(2,8);return`study-hub-${t}-${s}`},ie=async()=>{if(!a){d({title:"Error",description:"Please sign in to create a session.",variant:"destructive"});return}if(!i.title.trim()||!i.tutor_name.trim()||!i.scheduled_time&&!b&&!u){d({title:"Error",description:"Please fill in all required fields.",variant:"destructive"});return}$(!0);try{const t=u?u.meeting_room_id:se(),s=`https://meet.jit.si/${t}`;let r=i.scheduled_time;b&&(r=new Date().toISOString());const c=T.filter(n=>E.find(x=>x.id===n)?.type==="past_paper"),l=T.filter(n=>E.find(x=>x.id===n)?.type==="knowledge_organizer"),h=T.filter(n=>E.find(x=>x.id===n)?.type==="flashcard"),m=u?u.verification_token:crypto.randomUUID();if(u){const{error:n}=await g.from("virtual_sessions").update({title:i.title,description:i.description||null,subject:i.subject||null,tutor_name:i.tutor_name,scheduled_time:r,duration_minutes:parseInt(i.duration_minutes)||60,max_attendees:parseInt(i.max_attendees)||50}).eq("id",u.id).select();if(n)throw n;d({title:"Session Updated!",description:"Your session details have been updated."})}else{const{error:n}=await g.from("virtual_sessions").insert({created_by:a.id,title:i.title,description:i.description||null,subject:i.subject||null,tutor_name:i.tutor_name,scheduled_time:r,duration_minutes:parseInt(i.duration_minutes)||60,max_attendees:parseInt(i.max_attendees)||50,meeting_room_id:t,meeting_url:s,linked_past_papers:null,linked_knowledge_organizers:null,linked_flashcards:null,email_verified:!0,verification_token:m,status:"upcoming"});if(n)throw n;d({title:"Session Created!",description:"Your session is now live and visible to everyone."})}if(b){const n=a.email?.split("@")[0]||"Host",x=`${s}#userInfo.displayName="${encodeURIComponent(n)}"&config.prejoinPageEnabled=false`;window.open(x,"_blank","width=1200,height=800"),L(!0)}y(!1),P(null),f({title:"",description:"",subject:"",tutor_name:"",scheduled_time:"",duration_minutes:"60",max_attendees:"50"}),F([]),w()}catch(t){d({title:"Error",description:t.message||"Failed to save session. Please try again.",variant:"destructive"})}finally{$(!1)}},ae=async t=>{if(confirm("Are you sure you want to delete this session? This action cannot be undone."))try{const{error:s}=await g.from("virtual_sessions").delete().eq("id",t);if(s)throw s;d({title:"Session Deleted",description:"The session has been successfully removed."}),w()}catch{d({title:"Error",description:"Failed to delete session.",variant:"destructive"})}},re=t=>{P(t),f({title:t.title,description:t.description||"",subject:t.subject||"",tutor_name:t.tutor_name,scheduled_time:t.scheduled_time,duration_minutes:t.duration_minutes.toString(),max_attendees:t.max_attendees.toString()}),M(!1),y(!0)},ne=async t=>{if(!a){d({title:"Error",description:"Please sign in to register for sessions.",variant:"destructive"});return}try{const s=k.find(c=>c.id===t);if(!s)return;if(s.registered_users.includes(a.id)){d({title:"Already Registered",description:"You are already registered for this session."});return}const{error:r}=await g.rpc("register_for_session",{session_id_param:t,user_id_param:a.id});if(r)throw r;d({title:"Success",description:"You have been registered for this session!"}),w()}catch{d({title:"Error",description:"Failed to register. Please try again.",variant:"destructive"})}},le=t=>{const s=a?.email?.split("@")[0]||"Guest",r=`${t.meeting_url}#userInfo.displayName="${encodeURIComponent(s)}"&config.prejoinPageEnabled=false`;window.open(r,"_blank","width=1200,height=800"),a&&t.created_by===a.id&&d({title:"Starting Session",description:"Remember to log in as default moderator if prompted."})},oe=t=>{const s=new Date(t),r=new Date,c=(s.getTime()-r.getTime())/(1e3*60*60);return c<0?"Past":c<24?`Today, ${s.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`:c<48?`Tomorrow, ${s.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`:s.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})},de=t=>{const s=new Date(t);return{month:s.toLocaleDateString("en-US",{month:"short"}).toUpperCase(),day:s.getDate().toString()}};return e.jsxs(ge,{children:[e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6 animate-fade-in pb-12",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-3 rounded-xl bg-indigo-500/10 text-indigo-500",children:e.jsx(U,{className:"w-8 h-8"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Virtual Group Sessions"}),e.jsx("p",{className:"text-muted-foreground",children:"Live revision sessions led by expert tutors every week."})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Upcoming Sessions"}),I&&e.jsxs(p,{onClick:()=>{P(null),f({title:"",description:"",subject:"",tutor_name:"",scheduled_time:"",duration_minutes:"60",max_attendees:"50"}),y(!0)},children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"Create Session"]})]}),K?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(G,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"space-y-4",children:k.length===0?e.jsxs("div",{className:"text-center py-12 border rounded-xl border-dashed",children:[e.jsx(U,{className:"w-12 h-12 mx-auto text-muted-foreground mb-3 opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold text-muted-foreground",children:"No Upcomming Sessions"}),e.jsxs("p",{className:"text-sm text-muted-foreground max-w-sm mx-auto mt-1",children:["There are no verified sessions scheduled at the moment. ",I?"Create one to get started!":"Check back later!"]}),I&&e.jsxs(p,{variant:"outline",className:"mt-4",onClick:()=>y(!0),children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"Create Session"]})]}):k.map(t=>{const s=de(t.scheduled_time),r=a&&t.registered_users.includes(a.id),c=new Date(t.scheduled_time),l=(t.duration_minutes||60)*60*1e3,h=new Date(c.getTime()+l),m=new Date,n=m>=c&&m<=h,x=m>h,S=a&&t.created_by===a.id,ce=(n||t.status==="live"||S)&&!x;return e.jsx(fe,{className:"group hover:border-indigo-500/50 transition-colors",children:e.jsxs(je,{className:"p-6 flex flex-col md:flex-row md:items-center gap-6",children:[e.jsxs("div",{className:"flex-shrink-0 w-16 h-16 rounded-xl bg-indigo-100 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 flex flex-col items-center justify-center font-bold",children:[e.jsx("span",{className:"text-xs uppercase opacity-70",children:s.month}),e.jsx("span",{className:"text-2xl",children:s.day})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.subject&&e.jsx(j,{variant:"outline",className:"text-xs",children:t.subject}),n?e.jsx(j,{variant:"default",className:"text-xs animate-pulse bg-red-500 hover:bg-red-600",children:"LIVE NOW"}):x?e.jsx(j,{variant:"secondary",className:"text-xs",children:"Completed"}):e.jsx(j,{variant:"secondary",className:"text-xs",children:"Upcoming"}),e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center",children:[e.jsx(we,{className:"w-3 h-3 mr-1"}),oe(t.scheduled_time),e.jsxs("span",{className:"ml-1",children:["(",t.duration_minutes," mins)"]})]})]}),e.jsx("h3",{className:"text-xl font-bold group-hover:text-indigo-500 transition-colors",children:t.title}),t.description&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:t.description}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Hosted by ",t.tutor_name," â€¢ ",e.jsx(Se,{className:"w-3 h-3 inline pb-0.5"})," ",t.registered_users.length," registered"]}),(t.linked_past_papers?.length||t.linked_knowledge_organizers?.length||t.linked_flashcards?.length)&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[t.linked_past_papers&&t.linked_past_papers.length>0&&e.jsxs(j,{variant:"outline",className:"text-xs",children:[e.jsx(ke,{className:"w-3 h-3 mr-1"}),t.linked_past_papers.length," Past Paper",t.linked_past_papers.length>1?"s":""]}),t.linked_knowledge_organizers&&t.linked_knowledge_organizers.length>0&&e.jsxs(j,{variant:"outline",className:"text-xs",children:[e.jsx(W,{className:"w-3 h-3 mr-1"}),t.linked_knowledge_organizers.length," Knowledge Organizer",t.linked_knowledge_organizers.length>1?"s":""]}),t.linked_flashcards&&t.linked_flashcards.length>0&&e.jsxs(j,{variant:"outline",className:"text-xs",children:[e.jsx(W,{className:"w-3 h-3 mr-1"}),t.linked_flashcards.length," Flashcard Set",t.linked_flashcards.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[S&&e.jsxs(e.Fragment,{children:[e.jsx(p,{variant:"outline",size:"icon",onClick:()=>re(t),title:"Edit Session",children:e.jsx(Ce,{className:"w-4 h-4"})}),e.jsx(p,{variant:"outline",size:"icon",className:"text-red-500 hover:text-red-600 hover:bg-red-50",onClick:()=>ae(t.id),title:"Delete Session",children:e.jsx(De,{className:"w-4 h-4"})})]}),ce?e.jsxs(p,{className:S?"bg-amber-600 hover:bg-amber-700":"bg-green-600 hover:bg-green-700",onClick:()=>le(t),children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),S?"Start Session":"Join Session"]}):r?e.jsx(p,{variant:"outline",disabled:!0,children:"Registered"}):x?e.jsx(p,{variant:"ghost",disabled:!0,children:"Ended"}):e.jsx(p,{className:"bg-indigo-600 hover:bg-indigo-700",onClick:()=>ne(t.id),children:"Register Now"})]})]})},t.id)})})})]}),e.jsx(H,{open:D,onOpenChange:y,children:e.jsxs(O,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(q,{children:[e.jsx(A,{children:u?"Edit Virtual Session":"Create Virtual Session"}),e.jsx(B,{children:u?"Update your session details.":"Create a new virtual group revision session using Jitsi Meet."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"title",children:"Session Title *"}),e.jsx(N,{id:"title",value:i.title,onChange:t=>f({...i,title:t.target.value}),placeholder:"e.g., GCSE Maths: Algebra Revision"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"description",children:"Description"}),e.jsx(Ne,{id:"description",value:i.description,onChange:t=>f({...i,description:t.target.value}),placeholder:"What will be covered in this session?",className:"min-h-[100px]"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"subject",children:"Subject"}),e.jsxs(_e,{value:i.subject,onValueChange:t=>f({...i,subject:t}),children:[e.jsx(ve,{children:e.jsx(ye,{placeholder:"Select subject"})}),e.jsxs(be,{children:[e.jsx(v,{value:"Mathematics",children:"Mathematics"}),e.jsx(v,{value:"English Literature",children:"English Literature"}),e.jsx(v,{value:"Biology",children:"Biology"}),e.jsx(v,{value:"Chemistry",children:"Chemistry"}),e.jsx(v,{value:"Physics",children:"Physics"}),e.jsx(v,{value:"History",children:"History"}),e.jsx(v,{value:"Geography",children:"Geography"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"tutor_name",children:"Tutor Name *"}),e.jsx(N,{id:"tutor_name",value:i.tutor_name,onChange:t=>f({...i,tutor_name:t.target.value}),placeholder:"e.g., Dr. Smith"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(_,{htmlFor:"scheduled_time",children:"Scheduled Time *"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(xe,{id:"start-now",checked:b,onCheckedChange:t=>M(t===!0)}),e.jsx("label",{htmlFor:"start-now",className:"text-xs font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer text-indigo-600",children:"Start Now"})]})]}),e.jsx(N,{id:"scheduled_time",type:"datetime-local",value:i.scheduled_time,onChange:t=>f({...i,scheduled_time:t.target.value}),disabled:b})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"duration_minutes",children:"Duration (minutes)"}),e.jsx(N,{id:"duration_minutes",type:"number",value:i.duration_minutes,onChange:t=>f({...i,duration_minutes:t.target.value}),placeholder:"60"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"max_attendees",children:"Max Attendees"}),e.jsx(N,{id:"max_attendees",type:"number",value:i.max_attendees,onChange:t=>f({...i,max_attendees:t.target.value}),placeholder:"50"})]})]}),e.jsxs(J,{children:[e.jsx(p,{variant:"outline",onClick:()=>{y(!1),F([])},children:"Cancel"}),e.jsx(p,{onClick:ie,disabled:V,children:V?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-4 h-4 mr-2 animate-spin"}),u?"Update Session":"Create Session"]}):u?"Update Session":"Create Session"})]})]})}),e.jsx(H,{open:Z,onOpenChange:L,children:e.jsxs(O,{children:[e.jsxs(q,{children:[e.jsxs(A,{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-full bg-amber-100 text-amber-600",children:e.jsx(Ie,{className:"w-5 h-5"})}),"Important: Start Your Meeting"]}),e.jsx(B,{children:"Jitsi Meet requires the Creator (You) to officially start the meeting."})]}),e.jsx("div",{className:"space-y-4 py-2",children:e.jsxs("div",{className:"p-4 bg-muted rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold text-xs",children:"1"}),e.jsxs("p",{className:"text-sm",children:["In the Jitsi window that just opened, look for the ",e.jsx("strong",{children:'"Log In"'}),' or "I am the host" button.']})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold text-xs",children:"2"}),e.jsx("p",{className:"text-sm",children:"Log in with your Google or GitHub account to claim the room."})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold text-xs",children:"3"}),e.jsx("p",{className:"text-sm",children:"Once you are in, other participants will automatically join."})]})]})}),e.jsx(J,{children:e.jsx(p,{onClick:()=>L(!1),children:"I Understand"})})]})})]})}export{Xe as default};
